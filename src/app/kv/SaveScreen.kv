#:kivy 2.0.0

<SaveScreen>
    canvas.before:
        # Background layers
        Color:
            rgba: 1, 1, 1, 1
        Rectangle:  # placeholder texture layer
            source: "app/assets/placeholder_bg1.png"
            pos: self.pos
            size: self.size
        Rectangle:  # blurred overlay
            source: "app/assets/bg_blur.png"
            pos: self.pos
            size: self.size

        # Rounded inner panel
        Color:  
            rgba: 1, 1, 1, 1
        RoundedRectangle:
            id: inner_panel
            pos: self.x + 24, self.center_y - (self.height * 0.68 / 2)
            size: self.width - 48, self.height * 0.68
            radius: [40, 40, 40, 40]

        # Border for inner panel
        Color:
            rgba: 0, 0, 0, 0.05
        Line:
            rounded_rectangle: (self.x + 24, self.center_y - (self.height * 0.68 / 2), self.width - 48, self.height * 0.68, 40)
            width: 1.3

    # Header section
    BoxLayout:
        orientation: "horizontal"
        size_hint: None, None
        size: 480, 60
        pos_hint: {"x": 0.18, "top": 0.80}
        spacing: 6

        Image:  # save icon beside header text
            source: "app/assets/save.png"
            size_hint: None, None
            size: 48, 48
            fit_mode: "contain"
            mipmap: True

    BoxLayout:
        orientation: "horizontal"
        size_hint: None, None
        size: 480, 60
        pos_hint: {"x": 0.30, "top": 0.795}
        spacing: 5

        Label:  # main header label
            text: "Save"
            color: 3/255, 30/255, 0/255, 1
            font_size: 34
            bold: True
            valign: "middle"
            halign: "left"
            text_size: self.size

    # Divider line
    FloatLayout:
        size_hint: 1, 1
        canvas:
            Color:
                rgba: 0, 0, 0, 0.15
            Rectangle:
                size: self.width * 0.7, 1.5
                pos: self.width * 0.15, self.height * 0.68

    # Search box
    BoxLayout:
        size_hint: None, None
        size: 320, 30
        pos_hint: {"center_x": 0.5, "top": 0.65}
        padding: [8, 0, 8, 0]
        spacing: 6

        canvas.before:
            Color:  
                rgba: 1, 1, 1, 1
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [15, 15, 15, 15]

            Color:
                rgba: 220/255, 220/255, 220/255, 1
            Line:
                rounded_rectangle: (self.x, self.y, self.width, self.height, 15)
                width: 1.1

        TextInput:  # search input field
            id: search_input
            size_hint_x: 1
            multiline: False
            hint_text: "Search"
            hint_text_color: 166/255, 166/255, 166/255, 1
            foreground_color: 0, 0, 0, 1
            background_color: 0, 0, 0, 0
            padding: [12, (self.height - self.line_height)/2, 0, 0]
            font_size: 14
            cursor_color: 0, 0, 0, 1
            on_text: root.on_search_text(self.text)

        Image:
            source: "app/assets/search.png"
            size_hint: None, None
            size: 17, 17
            fit_mode: "contain"
            pos_hint: {"center_y": 0.5}
            mipmap: True

    # Preview area (thumbnail + metadata populated from app.analysis_result)
    BoxLayout:
        orientation: 'horizontal'
        size_hint: None, None
        size: 320, 110
        pos_hint: {"center_x": 0.5, "top": 0.62}
        spacing: 12

        Image:
            id: thumbnail_image
            source: ''
            size_hint: None, None
            size: 100, 100
            fit_mode: "contain"
            mipmap: True

        BoxLayout:
            orientation: 'vertical'
            spacing: 4
            size_hint_x: 1

            Label:
                id: save_disease_label
                text: ''
                font_size: 18
                bold: True
                halign: 'left'
                valign: 'middle'
                text_size: self.size

            Label:
                id: save_confidence_label
                text: ''
                font_size: 14
                halign: 'left'
                valign: 'middle'
                text_size: self.size

            Label:
                id: save_severity_label
                text: ''
                font_size: 14
                halign: 'left'
                valign: 'middle'
                text_size: self.size

    # Save area
    BoxLayout:
        orientation: "vertical"
        size_hint: None, None
        size: 320, 230
        pos_hint: {"center_x": 0.5, "top": 0.59}
        spacing: 6
        padding: [0, 0, 0, 6]

        ScrollView:  # scrollable list of tree cards
            id: scroll_view
            size_hint_y: 0.82
            bar_width: 6
            bar_color: 200/255, 200/255, 200/255, 1
            bar_inactive_color: 230/255, 230/255, 230/255, 0.5
            scroll_type: ['bars', 'content']
            effect_cls: "ScrollEffect"
            do_scroll_x: False
            do_scroll_y: True

            BoxLayout:  # container for tree list
                id: tree_list
                orientation: "vertical"
                spacing: 8
                size_hint_y: None
                height: self.minimum_height

        BoxLayout:  # input field for adding new trees
            size_hint_y: None
            height: 38
            spacing: 6

            canvas.before:
                Color:
                    rgba: 241/255, 241/255, 241/255, 1
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [10, 10, 10, 10]
                Color:
                    rgba: 0, 0, 0, 0.08
                Line:
                    rounded_rectangle: (self.x, self.y, self.width, self.height, 10)
                    width: 1

            TextInput:  # field for entering a new tree name
                id: add_input
                hint_text: "Add new tree"
                hint_text_color: 166/255, 166/255, 166/255, 1
                font_size: 14
                bold: True
                halign: "left"
                valign: "middle"
                foreground_color: 79/255, 79/255, 79/255, 1
                background_color: 0, 0, 0, 0
                padding: [12, 10, 0, 0]
                multiline: False
                cursor_color: 79/255, 79/255, 79/255, 1
                on_text_validate: root.on_add_tree()

            Button:  # plus button to add a tree
                text: "+"
                size_hint: None, 1
                width: 38
                font_size: 20
                background_normal: ""
                background_color: 0, 0, 0, 0
                color: 79/255, 79/255, 79/255, 1
                bold: True
                on_release: root.on_add_tree()

        # Editable fields for saving metadata (prefilled from analysis_result)
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: 124
            spacing: 6

            TextInput:
                id: record_title
                hint_text: 'Leaf name (optional)'
                hint_text_color: 166/255, 166/255, 166/255, 1
                font_size: 14
                multiline: False
                padding: [12, 10, 12, 10]

            TextInput:
                id: record_notes
                hint_text: 'Notes (optional)'
                hint_text_color: 166/255, 166/255, 166/255, 1
                font_size: 14
                multiline: True
                size_hint_y: None
                height: 70
                padding: [12, 10, 12, 10]

    # Save button
    RoundedButton:
        id: save_button
        size_hint: None, None
        size: 80, 44
        pos_hint: {"right": 0.85, "y": 0.20}
        on_release: root.on_save_button()

        canvas.before:
            Color:
                rgba: 0/255, 152/255, 0/255, 1
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [10, 10, 10, 10]

        BoxLayout:
            orientation: "horizontal"
            padding: [0, 0, 0, 0]
            spacing: 0
            size: save_button.size
            pos: save_button.pos

            Label:
                text: "Save"
                color: 1, 1, 1, 1
                font_size: 16
                bold: True
                halign: "center"
                valign: "middle"
                text_size: self.size

    # Back button
    RoundedButton:
        id: back_button
        size_hint: None, None
        size: 96, 42
        pos_hint: {"center_x": 0.25, "y": 0.05}
        on_release: app.root.current = 'capture_result'

        # button shadow
        canvas.before:
            Color:
                rgba: 0, 0, 0, 0.2
            RoundedRectangle:
                pos: self.x + 1, self.y - 2
                size: self.size
                radius: [14, 14, 14, 14]
            Color:
                rgba: 0.9, 0.9, 0.9, 0.4
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [14, 14, 14, 14]
            Color:
                rgba: 1, 1, 1, 0.7
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [14, 14, 14, 14]

        BoxLayout:
            orientation: "horizontal"
            size: back_button.size
            pos: back_button.pos
            spacing: 4

            Widget:
                size_hint_x: 1

            Image:
                source: "app/assets/back.png"
                fit_mode: "contain"
                size_hint: None, None
                size: 17, 17
                pos_hint: {"center_y": 0.5}
                
            Label:
                text: "Back"
                color: 3/255, 30/255, 0/255, 1
                font_size: 15
                bold: True
                size_hint_x: None
                width: self.texture_size[0]
                halign: "left"
                valign: "middle"
                pos_hint: {"center_y": 0.5}
            
            Widget:
                size_hint_x: 1