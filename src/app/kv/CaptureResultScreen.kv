#:kivy 2.0.0

<CaptureResultScreen>:
    # Background image
    canvas.before:
        Rectangle:
            source: "app/assets/placeholder_bg1.png"
            pos: self.pos
            size: self.size

    # Result Button
    RoundedButton:
        id: result_button
        size_hint: None, None
        size: 70, 70
        pos_hint: {"center_x": 0.20, "y": 0.07}
        on_release: app.last_screen = 'capture_result'; app.root.current = 'result'

        # Shadow, base color, and touch feedback
        canvas.before:
            Color:
                rgba: self.shadow_color
            RoundedRectangle:
                pos: self.x + self.shadow_offset_x, self.y - self.shadow_offset_y
                size: self.size
                radius: [18, 18, 18, 18]
            Color:
                rgba: 1, 1, 1, 1
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [18, 18, 18, 18]
            Color:
                rgba: 0.5, 0.5, 0.5, 0.3 if self.state == 'down' else 0  # Touch feedback
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [18, 18, 18, 18]

        # Layout containing icon and label
        RelativeLayout:
            size: result_button.size
            pos: result_button.pos
            BoxLayout:
                orientation: "vertical"
                size_hint: 1, 1
                spacing: 2
                padding: [0, 10, 0, 6]
                Image:
                    source: "app/assets/result.png"
                    fit_mode: "contain"
                    size_hint_y: 0.65
                    pos_hint: {"center_x": 0.5}
                    mipmap: True
                Label:
                    text: "Result"
                    color: 3/255, 30/255, 0/255, 1
                    font_size: 13
                    bold: True
                    size_hint_y: 0.35
                    halign: "center"
                    valign: "middle"
                    text_size: self.size

    # Retake Button
    GradientScanButton:
        id: retake_button
        size_hint: None, None
        size: 110, 110
        pos_hint: {"center_x": 0.5, "y": 0.04}
        on_release: app.root.current = 'scan'

        # Shadow, gradient, and touch feedback
        canvas.before:
            Color:
                rgba: self.shadow_color
            RoundedRectangle:
                pos: self.x + self.shadow_offset_x, self.y - self.shadow_offset_y
                size: self.size
                radius: [25, 25, 25, 25]
            Color:
                rgba: 1, 1, 1, 1
            RoundedRectangle:
                texture: self.gradient_texture
                pos: self.pos
                size: self.size
                radius: [25, 25, 25, 25]
            Color:
                rgba: 0.2, 0.2, 0.2, 0.3 if self.state == 'down' else 0  # Touch feedback
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [25, 25, 25, 25]

        # Layout containing scan icon and label
        RelativeLayout:
            size: retake_button.size
            pos: retake_button.pos
            BoxLayout:
                orientation: "vertical"
                size_hint: 1, 1
                spacing: 3
                padding: [0, 15, 0, 8]
                Image:
                    source: "app/assets/scan2.png"
                    fit_mode: "contain"
                    size_hint_y: 0.65
                    pos_hint: {"center_x": 0.5}
                    mipmap: True
                Label:
                    text: "Retake"
                    color: 1, 1, 1, 1
                    font_size: 17
                    bold: True
                    size_hint_y: 0.35
                    halign: "center"
                    valign: "middle"
                    text_size: self.size

    # Save Button
    RoundedButton:
        id: save_button
        size_hint: None, None
        size: 70, 70
        pos_hint: {"center_x": 0.80, "y": 0.07}
        on_release: app.root.current = 'save'

        # Shadow, base color, and touch feedback
        canvas.before:
            Color:
                rgba: self.shadow_color
            RoundedRectangle:
                pos: self.x + self.shadow_offset_x, self.y - self.shadow_offset_y
                size: self.size
                radius: [18, 18, 18, 18]
            Color:
                rgba: 1, 1, 1, 1
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [18, 18, 18, 18]
            Color:
                rgba: 0.5, 0.5, 0.5, 0.3 if self.state == 'down' else 0  # Touch feedback
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [18, 18, 18, 18]

        # Layout containing icon and label
        RelativeLayout:
            size: save_button.size
            pos: save_button.pos
            BoxLayout:
                orientation: "vertical"
                size_hint: 1, 1
                spacing: 2
                padding: [0, 10, 0, 6]
                Image:
                    source: "app/assets/save.png"
                    fit_mode: "contain"
                    size_hint_y: 0.65
                    pos_hint: {"center_x": 0.5}
                    mipmap: True
                Label:
                    text: "Save"
                    color: 3/255, 30/255, 0/255, 1
                    font_size: 13
                    bold: True
                    size_hint_y: 0.35
                    halign: "center"
                    valign: "middle"
                    text_size: self.size

    # Processed LCD Preview (shows normalized resized image if available)
    Image:
        id: lcd_preview
        size_hint: None, None
        size: 240, 400
        pos_hint: {"center_x": 0.5, "center_y": 0.55}
        fit_mode: "contain"
        source: app.lcd_display_image_path if hasattr(app, 'lcd_display_image_path') and app.lcd_display_image_path else (app.processed_image_path if hasattr(app, 'processed_image_path') and app.processed_image_path else (app.analysis_image_path if hasattr(app, 'analysis_image_path') else ''))
        canvas.before:
            Color:
                rgba: 1,1,1,0.15
            RoundedRectangle:
                pos: self.x-6, self.y-6
                size: self.width+12, self.height+12
                radius: [20,20,20,20]
        canvas.after:
            Color:
                rgba: 0,0,0,0.25
            Line:
                rounded_rectangle: (self.x-6, self.y-6, self.width+12, self.height+12, 20)

    # Severity Legend
    BoxLayout:
        id: severity_legend
        orientation: 'horizontal'
        size_hint: None, None
        size: 540, 40
        pos_hint: {"center_x": 0.5, "y": 0.47}
        spacing: 10
        canvas.before:
            Color:
                rgba: 1,1,1,0.22
            RoundedRectangle:
                pos: self.x, self.y
                size: self.width, self.height
                radius: [16,16,16,16]
        Label:
            text: 'Severity Scale:'
            font_size: 16
            bold: True
            color: 0,0,0,1
            size_hint_x: None
            width: self.texture_size[0] + 20
        Label:
            text: 'Healthy < 10%'
            font_size: 15
            color: 0,0.4,0,1
        Label:
            text: 'Mild 10–30%'
            font_size: 15
            color: 0.35,0.35,0,1
        Label:
            text: 'Moderate 30–60%'
            font_size: 15
            color: 0.55,0.28,0,1
        Label:
            text: 'Severe > 60%'
            font_size: 15
            color: 0.7,0,0,1
