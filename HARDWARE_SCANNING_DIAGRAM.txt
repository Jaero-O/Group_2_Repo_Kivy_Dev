# Hardware Scanning System - Visual Workflow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     MANGOFY HARDWARE SCANNING SYSTEM                      │
│                        Sequential Workflow Diagram                        │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│ STEP 1: HOME MOTOR                                                        │
│ Duration: 2-4s | Progress: 5-15%                                         │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
              ┌─────────────────────────────────────┐
              │   Motor moves BACKWARD until        │
              │   limit switch is triggered         │
              │                                     │
              │   Position: ← ← ← ← ← [LIMIT]      │
              │   Status: "Homing motor..."        │
              │   Result: Position = 0mm           │
              └─────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ STEP 2: SCAN AND STITCH (4 Frames)                                       │
│ Duration: 4-6s | Progress: 20-65%                                        │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
        ┌───────────────────────────┴───────────────────────────┐
        │                                                         │
        ▼                                                         ▼
┌──────────────────┐                                  ┌──────────────────┐
│  FRAME 1         │                                  │  MOTOR CONTROL   │
│  Position: 0mm   │◄─────────────────────────────────┤  Sequence        │
│  "Scanning 1/4"  │                                  │                  │
└──────────────────┘                                  └──────────────────┘
        │                                                         │
        ▼                                                         ▼
┌──────────────────┐                                  ┌──────────────────┐
│  FRAME 2         │                                  │  Move to 50mm    │
│  Position: 50mm  │◄─────────────────────────────────┤  Stabilize 200ms │
│  "Scanning 2/4"  │                                  │                  │
└──────────────────┘                                  └──────────────────┘
        │                                                         │
        ▼                                                         ▼
┌──────────────────┐                                  ┌──────────────────┐
│  FRAME 3         │                                  │  Move to 100mm   │
│  Position: 100mm │◄─────────────────────────────────┤  Stabilize 200ms │
│  "Scanning 3/4"  │                                  │                  │
└──────────────────┘                                  └──────────────────┘
        │                                                         │
        ▼                                                         ▼
┌──────────────────┐                                  ┌──────────────────┐
│  FRAME 4         │                                  │  Move to 150mm   │
│  Position: 150mm │◄─────────────────────────────────┤  Stabilize 200ms │
│  "Scanning 4/4"  │                                  │                  │
└──────────────────┘                                  └──────────────────┘
        │
        │  Frames Captured: [Frame1.jpg, Frame2.jpg, Frame3.jpg, Frame4.jpg]
        │
        ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  STITCHING ENGINE                                                         │
│  Status: "Stitching Frames..."                                           │
│  Progress: 70-85%                                                         │
└──────────────────────────────────────────────────────────────────────────┘
        │
        │  Horizontal Stitching with 15% Overlap:
        │
        │  [Frame 1]──────┐
        │        └─[Frame 2]──────┐
        │              └─[Frame 3]──────┐
        │                    └─[Frame 4]
        │
        │  Overlap Blending:
        │  ┌────────┬────────┬────────┬────────┐
        │  │ Frame1 │ Blend  │ Frame2 │ Blend  │
        │  │        │ 15%    │        │ 15%    │ ...
        │  └────────┴────────┴────────┴────────┘
        │
        ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  OUTPUT: stitched_raw.jpg                                                 │
│  - Non-processed stitched image                                          │
│  - Original pixel dimensions                                             │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ STEP 3: PREPROCESSING                                                     │
│ Duration: 0.5-1s | Progress: 85-92%                                      │
│ Status: "Processing image..."                                            │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
        ┌───────────────────────────┴───────────────────────────┐
        │                                                         │
        ▼                                                         ▼
┌──────────────────┐                                  ┌──────────────────┐
│  CONTRAST        │                                  │  COLOR           │
│  ENHANCEMENT     │                                  │  ENHANCEMENT     │
│  +20%            │                                  │  Saturation +10% │
└──────────────────┘                                  └──────────────────┘
        │                                                         │
        └───────────────────────────┬───────────────────────────┘
                                    │
                                    ▼
        ┌──────────────────────────────────────────────┐
        │           GENERATE 3 OUTPUTS:                 │
        ├──────────────────────────────────────────────┤
        │                                              │
        │  1. stitched_processed.jpg                  │
        │     - Enhanced                              │
        │     - Original dimensions                   │
        │                                             │
        │  2. stitched_processed_480x800.jpg         │
        │     - Enhanced                             │
        │     - Resized for LCD (480×800)           │
        │     - Maintains aspect ratio              │
        │     - Used for disease analysis           │
        │                                            │
        └────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ DISEASE ANALYSIS                                                          │
│ Duration: 1-3s | Progress: 92-100%                                       │
│ Status: "Analyzing disease..."                                           │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
        ┌──────────────────────────────────────────────┐
        │   TensorFlow Lite Model                      │
        │   Input: stitched_processed_480x800.jpg     │
        │   Output: Disease Label + Confidence        │
        │           Severity % + Level                │
        └──────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ RESULTS DISPLAY                                                           │
│ Screen: CaptureResultScreen                                              │
│ Progress: 100% COMPLETE                                                  │
└──────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════
                         HARDWARE COMPONENTS
═══════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────┐
│ MECHANICAL SYSTEM                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌────────────┐      ┌────────────┐      ┌────────────┐                │
│  │   NEMA 17  │─────▶│   PINION   │─────▶│    RACK    │                │
│  │   STEPPER  │      │  20 teeth  │      │   GEAR     │                │
│  │            │      │            │      │            │                │
│  └────────────┘      └────────────┘      └────────────┘                │
│       200              1.8° step          Module 1.5                     │
│    steps/rev           per step           200mm travel                  │
│                                                                           │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │           LINEAR RAIL (MGN12H)                                      │ │
│  │  [HOME]═══════════════════════════════════════════════[END]        │ │
│  │    0mm        50mm       100mm      150mm      200mm                │ │
│  │    │          │           │          │          │                   │ │
│  │  ┌─┴──┐     ┌─┴──┐     ┌─┴──┐     ┌─┴──┐                          │ │
│  │  │ F1 │     │ F2 │     │ F3 │     │ F4 │                          │ │
│  │  └────┘     └────┘     └────┘     └────┘                          │ │
│  │  Frame      Frame      Frame      Frame                            │ │
│  │  Position   Position   Position   Position                         │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  ┌────────────┐                                                          │
│  │   LIMIT    │  Active LOW trigger at home position                    │
│  │  SWITCH    │  GPIO 23                                                │
│  └────────────┘                                                          │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ CAMERA SYSTEM                                                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌────────────────────────────────────────────┐                         │
│  │  Raspberry Pi Camera Module V2             │                         │
│  │  ┌──────────────────────────────────────┐  │                         │
│  │  │  Sony IMX219 8MP Sensor              │  │                         │
│  │  │  Resolution: 3280×2464 (max)         │  │                         │
│  │  │  Configured: 1640×1232               │  │                         │
│  │  │  Interface: CSI Ribbon Cable         │  │                         │
│  │  └──────────────────────────────────────┘  │                         │
│  └────────────────────────────────────────────┘                         │
│                      │                                                   │
│                      ▼                                                   │
│  ┌────────────────────────────────────────────┐                         │
│  │  Field of View                             │                         │
│  │  ┌──────────────────────────────────────┐  │                         │
│  │  │  ╔═══════════════════════════════╗   │  │                         │
│  │  │  ║    MANGO LEAF SAMPLE          ║   │  │                         │
│  │  │  ║    (moves under camera)       ║   │  │                         │
│  │  │  ╚═══════════════════════════════╝   │  │                         │
│  │  └──────────────────────────────────────┘  │                         │
│  └────────────────────────────────────────────┘                         │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ GPIO CONNECTIONS                                                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  Raspberry Pi GPIO         Stepper Driver (A4988/DRV8825)                │
│  ┌────────────┐            ┌────────────┐                                │
│  │  GPIO 17   │───────────▶│    STEP    │                                │
│  │  GPIO 27   │───────────▶│    DIR     │                                │
│  │  GPIO 22   │───────────▶│   ENABLE   │                                │
│  │  GPIO 23   │◀───────────│ (via limit switch)                         │
│  │  GND       │───────────▶│    GND     │                                │
│  └────────────┘            └────────────┘                                │
│                                   │                                      │
│                            ┌──────┴──────┐                               │
│                            │   NEMA 17   │                               │
│                            │   STEPPER   │                               │
│                            └─────────────┘                               │
│                                                                           │
│  External 12V 2A Power Supply ───▶ Driver VDD/GND                        │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════
                            TIMING DIAGRAM
═══════════════════════════════════════════════════════════════════════════

0s      2s      4s      6s      8s      10s     12s
│───────┼───────┼───────┼───────┼───────┼───────┤
│       │       │       │       │       │       │
│ HOME  │ SCAN FRAMES   │STITCH │PREP   │ANALYZE│
│ MOTOR │ 1  2  3  4    │FRAMES │IMAGE  │DISEASE│
│       │               │       │       │       │
├───────┴───────────────┴───────┴───────┴───────┤
│                                               │
│   Progress Bar:                               │
│   [████████████████████████████████████████]  │
│   0%     25%     50%     75%     100%          │
│                                               │
│   Status Messages:                            │
│   "Homing motor..."                           │
│   "Scanning 1 out of 4 Frames..."            │
│   "Scanning 2 out of 4 Frames..."            │
│   "Scanning 3 out of 4 Frames..."            │
│   "Scanning 4 out of 4 Frames..."            │
│   "Stitching Frames..."                      │
│   "Processing image..."                       │
│   "Analyzing disease..."                      │
│   "Capture complete"                          │
│                                               │
└───────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════
                         SOFTWARE ARCHITECTURE
═══════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────┐
│ USER INTERFACE (Kivy Screens)                                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ScanScreen           ScanningScreen        CaptureResultScreen          │
│  ┌────────┐           ┌────────────┐        ┌────────────┐              │
│  │  [SCAN]│──────────▶│ Progress   │───────▶│  Disease   │              │
│  │  Button│           │ Status     │        │  Results   │              │
│  └────────┘           │ Progress % │        │  Image     │              │
│                       │ Frame N/4  │        │  Severity  │              │
│                       └────────────┘        └────────────┘              │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ CORE MODULES (Python Classes)                                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  MotorController                 MultiFrameCapture                       │
│  ┌────────────────┐              ┌──────────────────┐                   │
│  │ home_motor()   │              │ run()            │                   │
│  │ move_to_pos()  │◀─────────────│ _capture_frames()│                   │
│  │ scan_sequence()│              │ _stitch_frames() │                   │
│  └────────────────┘              │ _preprocess()    │                   │
│         │                        └──────────────────┘                   │
│         │                                 │                              │
│         ▼                                 ▼                              │
│  ┌────────────────┐              ┌──────────────────┐                   │
│  │ RPi.GPIO       │              │ picamera         │                   │
│  │ (Hardware I/O) │              │ PIL (Imaging)    │                   │
│  └────────────────┘              └──────────────────┘                   │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ OUTPUT FILES (data/captures/)                                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  frame_1.jpg  ┐                                                          │
│  frame_2.jpg  ├─────▶ stitched_raw.jpg ──┐                              │
│  frame_3.jpg  │                           │                              │
│  frame_4.jpg  ┘                           ├──▶ stitched_processed.jpg   │
│                                           │                              │
│                                           └──▶ stitched_processed_480×800│
│                                                (Used for analysis)       │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════
                    SIMULATION MODE vs HARDWARE MODE
═══════════════════════════════════════════════════════════════════════════

┌────────────────────────────────┬─────────────────────────────────────────┐
│ SIMULATION MODE                 │ HARDWARE MODE                           │
│ (Development / Windows)         │ (Production / Raspberry Pi)             │
├────────────────────────────────┼─────────────────────────────────────────┤
│                                │                                         │
│ • RPi.GPIO not available       │ • RPi.GPIO installed                    │
│ • picamera not available       │ • picamera installed                    │
│ • Uses time.sleep() delays     │ • Actual GPIO pin control               │
│ • Duplicates test image 4x     │ • Captures 4 real frames                │
│ • No motor movement            │ • Motor moves leaf 0→50→100→150mm       │
│ • Same progress callbacks      │ • Same progress callbacks               │
│ • Same output structure        │ • Same output structure                 │
│                                │                                         │
│ USAGE:                         │ USAGE:                                  │
│ export MANGOFY_TEST_IMAGE=     │ # No test image needed                  │
│   "path/to/test.jpg"           │ python kivy-lcd-app/main.py             │
│ python kivy-lcd-app/main.py    │                                         │
│                                │                                         │
└────────────────────────────────┴─────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════
                              END OF DIAGRAM
═══════════════════════════════════════════════════════════════════════════
